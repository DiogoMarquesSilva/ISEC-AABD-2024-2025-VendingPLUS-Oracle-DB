CREATE OR REPLACE VIEW VIEW_A AS
SELECT 
    M.ID_MAQUINA AS IDMAQUINA,
    R.DATA_REPOSICAO AS DATA_HORA_ABAST,
    M.DESIGNACAO AS LOCAL,
    SUM(R.QUANTIDADE_REPOSTA) AS QUANT_ABASTECIDA,
    COUNT(DISTINCT R.ID_PRODUTO) AS NUM_PRODUTOS_DIFERENTES
FROM 
    MAQUINA M
JOIN COMPARTIMENTO C ON M.ID_MAQUINA = C.ID_MAQUINA
JOIN REPOSICAO R ON R.ID_COMPARTIMENTO = C.ID_COMPARTIMENTO
JOIN PRODUTO P ON R.ID_PRODUTO = P.ID_PRODUTO
JOIN POSSUI PO ON M.ID_MAQUINA = PO.ID_MAQUINA AND P.ID_PRODUTO = PO.ID_PRODUTO
WHERE 
    P.TIPO = 'Snacks' -- Tipo de produto 'Snacks'
    AND M.LOCALIZACAO LIKE '%Coimbra%' -- Máquinas localizadas em Coimbra
    AND TRUNC(R.DATA_REPOSICAO) = TRUNC(SYSDATE) - 3 -- Reabastecidas ontem
    AND PO.QUANT_EM_STOCK = 0 -- Máquinas que atualmente não possuem stock desse produto
    AND M.STATUS = 'Ativa' -- Só maquinas ativas
GROUP BY 
    M.ID_MAQUINA, R.DATA_REPOSICAO, M.DESIGNACAO
ORDER BY 
    QUANT_ABASTECIDA DESC;


--  tabela MAQUINA
INSERT INTO MAQUINA (ID_MAQUINA, DESIGNACAO, LOCALIZACAO, STATUS) 
VALUES (1, 'CoimbraShopping', 'Coimbra', 'Ativa');

INSERT INTO MAQUINA (ID_MAQUINA, DESIGNACAO, LOCALIZACAO, STATUS) 
VALUES (2, 'ForumCoimbra', 'Coimbra', 'Ativa');

INSERT INTO MAQUINA (ID_MAQUINA, DESIGNACAO, LOCALIZACAO, STATUS) 
VALUES (3, 'EstacaoCoimbra', 'Coimbra', 'Inativa');

--  tabela PRODUTO
INSERT INTO PRODUTO (ID_PRODUTO, NOME, TIPO) 
VALUES (1, 'Batata Frita', 'Snacks');

INSERT INTO PRODUTO (ID_PRODUTO, NOME, TIPO) 
VALUES (2, 'Chocolate', 'Snacks');

INSERT INTO PRODUTO (ID_PRODUTO, NOME, TIPO) 
VALUES (3, 'Refrigerante', 'Bebidas');

--  tabela COMPARTIMENTO
INSERT INTO COMPARTIMENTO (ID_COMPARTIMENTO, ID_MAQUINA, CODIGO_COMPARTIMENTO, QUANTIDADE_ATUAL, CAPACIDADE_MAX, QUANTIDADE_MINIMA, PRECO) 
VALUES (1, 1, 'A1', 0, 50, 5, 1.50);

INSERT INTO COMPARTIMENTO (ID_COMPARTIMENTO, ID_MAQUINA, CODIGO_COMPARTIMENTO, QUANTIDADE_ATUAL, CAPACIDADE_MAX, QUANTIDADE_MINIMA, PRECO) 
VALUES (2, 1, 'A2', 0, 50, 5, 2.00);

INSERT INTO COMPARTIMENTO (ID_COMPARTIMENTO, ID_MAQUINA, CODIGO_COMPARTIMENTO, QUANTIDADE_ATUAL, CAPACIDADE_MAX, QUANTIDADE_MINIMA, PRECO) 
VALUES (3, 2, 'B1', 10, 50, 5, 1.75);

-- tabela POSSUI
INSERT INTO POSSUI (ID_MAQUINA, ID_PRODUTO, QUANT_EM_STOCK) 
VALUES (1, 1, 0);

INSERT INTO POSSUI (ID_MAQUINA, ID_PRODUTO, QUANT_EM_STOCK) 
VALUES (1, 2, 0);

INSERT INTO POSSUI (ID_MAQUINA, ID_PRODUTO, QUANT_EM_STOCK) 
VALUES (2, 1, 10);


-- tabela VISITA
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_RECLAMACAO, ID_MAQUINA, MOTIVO, DISTANCIA) 
VALUES (1, NULL, NULL, 1, 'Reabastecimento', 5);

INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_RECLAMACAO, ID_MAQUINA, MOTIVO, DISTANCIA) 
VALUES (2, NULL, NULL, 1, 'Reabastecimento', 10);

INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_RECLAMACAO, ID_MAQUINA, MOTIVO, DISTANCIA) 
VALUES (3, NULL, NULL, 2, 'Reabastecimento', 15);


-- tabela REPOSICAO com ID_VISITA
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO) 
VALUES (1, 1, 1, 1, 24, TRUNC(SYSDATE) - 1);

INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO) 
VALUES (2, 2, 2, 2, 10, TRUNC(SYSDATE) - 1);

INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO) 
VALUES (3, 3, 1, 3, 15, TRUNC(SYSDATE) - 1);

UPDATE REPOSICAO
SET DATA_REPOSICAO = TRUNC(SYSDATE) - 1
WHERE ID_REPOSICAO IN (1, 2, 3);


CREATE OR REPLACE VIEW VIEW_B AS
SELECT 
    M.ID_MAQUINA AS IDMAQUINA, 
    M.DESIGNACAO AS LOCAL, 
    P.ID_PRODUTO AS REFPRODUTO, 
    P.NOME AS PRODUTO, 
    PO.QUANT_EM_STOCK AS QUANT_EXISTENTE, 
    SUM(R.QUANTIDADE_REPOSTA) AS QUANT_ABASTECIDA
FROM MAQUINA M
JOIN COMPARTIMENTO C ON M.ID_MAQUINA = C.ID_MAQUINA
JOIN REPOSICAO R ON C.ID_COMPARTIMENTO = R.ID_COMPARTIMENTO
JOIN PRODUTO P ON R.ID_PRODUTO = P.ID_PRODUTO
JOIN POSSUI PO ON M.ID_MAQUINA = PO.ID_MAQUINA AND PO.ID_PRODUTO = P.ID_PRODUTO
JOIN VISITA VI ON M.ID_MAQUINA = VI.ID_MAQUINA
JOIN VIAGEM VG ON VI.ID_VIAGEM = VG.ID_VIAGEM
WHERE VG.ID_VIAGEM = '2025031105'
GROUP BY M.ID_MAQUINA, M.DESIGNACAO, P.ID_PRODUTO, P.NOME, PO.QUANT_EM_STOCK, VI.DATA_VISITA
ORDER BY VI.DATA_VISITA ASC, QUANT_ABASTECIDA DESC;




--Inserir o armazém de origem
INSERT INTO ARMAZEM VALUES (10,'Coimbra', 'Armazém Central', 38.722252, -9.139337);

--Inserir o funcionário responsável
INSERT INTO FUNCIONARIO VALUES (10, 'João Silva', 912345678);

--Inserir o veículo utilizado
INSERT INTO VEICULO VALUES (10, 'AA-10-BB', 2000, 400, 'Volvo', 'FH16');

--Inserir a rota
INSERT INTO ROTA VALUES (10, 10, 'Rota Coimbra Sul', 120);

--Inserir a viagem específica
INSERT INTO VIAGEM VALUES (2025031105, 10, 10, 10, TO_DATE('2025-03-11 08:00:00', 'YYYY-MM-DD HH24:MI:SS'),
                          TO_DATE('2025-03-11 18:00:00', 'YYYY-MM-DD HH24:MI:SS'),
                          150);

--Inserir máquinas que serão visitadas
INSERT INTO MAQUINA (ID_MAQUINA, LOCALIZACAO, DESIGNACAO, LATITUDE, LONGITUDE, 
                     DATA_HORA_ULTIMO_REPORT, DATA_HORA_ULTIMA_VISITA, STATUS)  
VALUES (10, 'Coimbra', 'Estação Autocarros', 38.768056, -9.098889,  
        TO_DATE('2025-04-01 10:30:00', 'YYYY-MM-DD HH24:MI:SS'),  
        TO_DATE('2025-04-02 15:45:00', 'YYYY-MM-DD HH24:MI:SS'),  
        'Ativa');
INSERT INTO MAQUINA (ID_MAQUINA, LOCALIZACAO, DESIGNACAO, LATITUDE, LONGITUDE, 
                     DATA_HORA_ULTIMO_REPORT, DATA_HORA_ULTIMA_VISITA, STATUS)  
VALUES (11, 'Coimbra', 'AlmaShopping', 38.769722, -9.093611,  
        TO_DATE('2025-04-01 11:00:00', 'YYYY-MM-DD HH24:MI:SS'),  
        TO_DATE('2025-04-02 16:00:00', 'YYYY-MM-DD HH24:MI:SS'),  
        'Ativa');

INSERT INTO MAQUINA (ID_MAQUINA, LOCALIZACAO, DESIGNACAO, LATITUDE, LONGITUDE, 
                     DATA_HORA_ULTIMO_REPORT, DATA_HORA_ULTIMA_VISITA, STATUS)  
VALUES (12, 'Coimbra', 'Bombeiros', 38.770833, -9.091667,  
        TO_DATE('2025-04-01 12:00:00', 'YYYY-MM-DD HH24:MI:SS'),  
        TO_DATE('2025-04-02 17:30:00', 'YYYY-MM-DD HH24:MI:SS'),  
        'Ativa');


--Inserir produtos
INSERT INTO PRODUTO (ID_PRODUTO, NOME, PRECO_MEDIO, UNIDADES_VENDIDAS, QUANT_EM_MAQUINAS, 
                     QUANT_EM_STOCK, CAPACIDADE_MAX_COMPARTIMENTO, TIPO)  
VALUES (10, 'Sumo de Manga', 1.00, 100, 50, 200, 500, 'Bebidas');

INSERT INTO PRODUTO (ID_PRODUTO, NOME, PRECO_MEDIO, UNIDADES_VENDIDAS, QUANT_EM_MAQUINAS, 
                     QUANT_EM_STOCK, CAPACIDADE_MAX_COMPARTIMENTO, TIPO)  
VALUES (11, 'Sumo de Maçã', 2.50, 80, 30, 150, 300, 'Bebidas');
INSERT INTO PRODUTO (ID_PRODUTO, NOME, PRECO_MEDIO, UNIDADES_VENDIDAS, QUANT_EM_MAQUINAS, 
                     QUANT_EM_STOCK, CAPACIDADE_MAX_COMPARTIMENTO, TIPO)  
VALUES (12, 'Sanduíche de Frango', 3.50, 60, 20, 100, 200, 'Comida');


--Inserir compartimentos nas máquinas
-- Máquina 10
INSERT INTO COMPARTIMENTO VALUES (10, 10, 'A1', 5, 50, 5, 1.00);
INSERT INTO COMPARTIMENTO VALUES (11, 10, 'A2', 3, 40, 5, 2.50);
-- Máquina 11
INSERT INTO COMPARTIMENTO VALUES (12, 11, 'B1', 8, 60, 5, 1.00);
INSERT INTO COMPARTIMENTO VALUES (13, 11, 'B2', 4, 50, 5, 3.50);
-- Máquina 12
INSERT INTO COMPARTIMENTO VALUES (14, 12, 'C1', 2, 30, 5, 1.00);
INSERT INTO COMPARTIMENTO VALUES (15, 12, 'C2', 6, 40, 5, 2.50);

--Inserir relação de produtos nas máquinas (POSSUI)
-- Máquina 10
INSERT INTO POSSUI VALUES (10, 10, 5, 50);
INSERT INTO POSSUI VALUES (10, 11, 3, 40);
-- Máquina 11
INSERT INTO POSSUI VALUES (11, 10, 8, 60);
INSERT INTO POSSUI VALUES (11, 12, 4, 50);
-- Máquina 12
INSERT INTO POSSUI VALUES (12, 10, 2, 30);
INSERT INTO POSSUI VALUES (12, 11, 6, 40);


--Inserir visitas realizadas durante a viagem
INSERT INTO VISITA VALUES (10, 2025031105, NULL, 10, 'Reabastecimento', 5, TO_DATE('2025-03-11 09:00:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO VISITA VALUES (11, 2025031105, NULL, 11, 'Reabastecimento', 10, TO_DATE('2025-03-11 11:30:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO VISITA VALUES (12, 2025031105, NULL, 12, 'Reabastecimento', 15, TO_DATE('2025-03-11 14:00:00', 'YYYY-MM-DD HH24:MI:SS'));



--Inserir reposições realizadas em cada visita
-- Visita 10 (Máquina 10)
INSERT INTO REPOSICAO VALUES (10, 10, 10, 10, 20, TO_DATE('2025-03-11', 'YYYY-MM-DD'), 'Reposição normal');
INSERT INTO REPOSICAO VALUES (11, 11, 11, 10, 15, TO_DATE('2025-03-11', 'YYYY-MM-DD'), 'Reposição normal');
-- Visita 11 (Máquina 11)
INSERT INTO REPOSICAO VALUES (12, 12, 10, 11, 25, TO_DATE('2025-03-11', 'YYYY-MM-DD'), 'Reposição urgente');
INSERT INTO REPOSICAO VALUES (13, 13, 12, 11, 20, TO_DATE('2025-03-11', 'YYYY-MM-DD'), 'Reposição normal');
-- Visita 12 (Máquina 12)
INSERT INTO REPOSICAO VALUES (14, 14, 10, 12, 15, TO_DATE('2025-03-11', 'YYYY-MM-DD'), 'Reposição normal');
INSERT INTO REPOSICAO VALUES (15, 15, 11, 12, 10, TO_DATE('2025-03-11', 'YYYY-MM-DD'), 'Reposição normal');



CREATE OR REPLACE FUNCTION TOTAL_VENDIDOS_ULTIMA_REPOS (
    VID_MAQUINA IN NUMBER,
    VID_PRODUTO IN NUMBER
) RETURN NUMBER IS
    TOTAL NUMBER;
    DATA_ULT_REPOS DATE;
BEGIN
    -- Buscar a última reposição do produto na máquina
    SELECT MAX(R.DATA_REPOSICAO) INTO DATA_ULT_REPOS
    FROM REPOSICAO R
    JOIN COMPARTIMENTO C ON R.ID_COMPARTIMENTO = C.ID_COMPARTIMENTO
    WHERE C.ID_MAQUINA = VID_MAQUINA
    AND R.ID_PRODUTO = VID_PRODUTO;

    -- Contar as vendas desde essa reposição
    SELECT COUNT(*) INTO TOTAL
    FROM VENDA
    WHERE ID_MAQUINA = VID_MAQUINA
    AND ID_PRODUTO = VID_PRODUTO
    AND DATA_HORA >= DATA_ULT_REPOS;

    RETURN NVL(TOTAL, 0);
END;
/

CREATE OR REPLACE VIEW VIEW_PRODUTOS_VENDIDOS_MES AS
SELECT 
    ID_MAQUINA,
    ID_PRODUTO,
    COUNT(*) AS TOTAL_VENDAS
FROM VENDA
WHERE EXTRACT(MONTH FROM DATA_HORA) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -1))
AND EXTRACT(YEAR FROM DATA_HORA) = EXTRACT(YEAR FROM ADD_MONTHS(SYSDATE, -1))
GROUP BY ID_MAQUINA, ID_PRODUTO;


CREATE OR REPLACE VIEW VIEW_C AS
SELECT 
    M.ID_MAQUINA AS IDMAQUINA,
    M.DESIGNACAO AS LOCAL,
    P.ID_PRODUTO AS REF_PRODUTO,
    P.NOME AS PRODUTO,
    NVL(V.TOTAL_VENDAS, 0) AS QUANT_VENDIDA_MES,
    TOTAL_VENDIDOS_ULTIMA_REPOS(M.ID_MAQUINA, P.ID_PRODUTO) AS QUANT_VEND_DESDE_ULTIMO
FROM MAQUINA M
JOIN COMPARTIMENTO C ON M.ID_MAQUINA = C.ID_MAQUINA
JOIN ESTA_NUM E ON C.ID_COMPARTIMENTO = E.ID_COMPARTIMENTO
JOIN PRODUTO P ON E.ID_PRODUTO = P.ID_PRODUTO
LEFT JOIN VIEW_PRODUTOS_VENDIDOS_MES V ON M.ID_MAQUINA = V.ID_MAQUINA AND P.ID_PRODUTO = V.ID_PRODUTO
WHERE P.ID_PRODUTO IN (
    SELECT ID_PRODUTO
    FROM VIEW_PRODUTOS_VENDIDOS_MES VPM
    WHERE VPM.ID_MAQUINA = M.ID_MAQUINA
    AND VPM.TOTAL_VENDAS = (
        SELECT MAX(TOTAL_VENDAS)
        FROM VIEW_PRODUTOS_VENDIDOS_MES
        WHERE ID_MAQUINA = M.ID_MAQUINA
    )
)
AND P.ID_PRODUTO IN (SELECT ID_PRODUTO FROM POSSUI WHERE QUANT_EM_STOCK <= CAPACIDADE_MAX * 0.5)
ORDER BY QUANT_VENDIDA_MES ASC;




-- Inserir novas máquinas
INSERT INTO MAQUINA (ID_MAQUINA, LOCALIZACAO, DESIGNACAO, LATITUDE, LONGITUDE, 
                     DATA_HORA_ULTIMO_REPORT, DATA_HORA_ULTIMA_VISITA, STATUS)  
VALUES (13, 'Coimbra', 'Centro de Sáude', 38.715833, -9.122222,  
        TO_DATE('2025-04-01 10:30:00', 'YYYY-MM-DD HH24:MI:SS'),  
        TO_DATE('2025-04-02 15:45:00', 'YYYY-MM-DD HH24:MI:SS'),  
        'Ativa');

INSERT INTO MAQUINA (ID_MAQUINA, LOCALIZACAO, DESIGNACAO, LATITUDE, LONGITUDE, 
                     DATA_HORA_ULTIMO_REPORT, DATA_HORA_ULTIMA_VISITA, STATUS)
VALUES (14, 'Coimbra', 'Continente', 41.178611, -8.598056,  
        TO_DATE('2025-04-01 11:00:00', 'YYYY-MM-DD HH24:MI:SS'),  
        TO_DATE('2025-04-02 16:00:00', 'YYYY-MM-DD HH24:MI:SS'),  
        'Ativa');

INSERT INTO MAQUINA (ID_MAQUINA, LOCALIZACAO, DESIGNACAO, LATITUDE, LONGITUDE, 
                     DATA_HORA_ULTIMO_REPORT, DATA_HORA_ULTIMA_VISITA, STATUS)
VALUES (15, 'Coimbra', 'ISEC Polivalente', 40.186667, -8.426667,  
        TO_DATE('2025-04-01 12:00:00', 'YYYY-MM-DD HH24:MI:SS'),  
        TO_DATE('2025-04-02 17:00:00', 'YYYY-MM-DD HH24:MI:SS'),  
        'Ativa');


-- Inserir novos produtos 
INSERT INTO PRODUTO (ID_PRODUTO, NOME, PRECO_MEDIO, UNIDADES_VENDIDAS, QUANT_EM_MAQUINAS, 
                     QUANT_EM_STOCK, CAPACIDADE_MAX_COMPARTIMENTO, TIPO)  
VALUES (13, 'Água com Gás', 1.50, 100, 50, 200, 300, 'Bebidas');

INSERT INTO PRODUTO (ID_PRODUTO, NOME, PRECO_MEDIO, UNIDADES_VENDIDAS, QUANT_EM_MAQUINAS, 
                     QUANT_EM_STOCK, CAPACIDADE_MAX_COMPARTIMENTO, TIPO)  
VALUES (14, 'Expresso', 0.70, 150, 75, 300, 400, 'Bebidas Quentes');
INSERT INTO PRODUTO (ID_PRODUTO, NOME, PRECO_MEDIO, UNIDADES_VENDIDAS, QUANT_EM_MAQUINAS, 
                     QUANT_EM_STOCK, CAPACIDADE_MAX_COMPARTIMENTO, TIPO)  
VALUES (15, 'Salada', 4.00, 60, 30, 120, 150, 'Comida');
INSERT INTO PRODUTO (ID_PRODUTO, NOME, PRECO_MEDIO, UNIDADES_VENDIDAS, QUANT_EM_MAQUINAS, 
                     QUANT_EM_STOCK, CAPACIDADE_MAX_COMPARTIMENTO, TIPO)  
VALUES (16, 'Batatas Fritas', 1.80, 90, 45, 180, 200, 'Snacks');


-- Inserir compartimentos 
-- Máquina 13
INSERT INTO COMPARTIMENTO VALUES (16, 13, 'D1', 20, 50, 10, 1.50);
INSERT INTO COMPARTIMENTO VALUES (17, 13, 'D2', 15, 40, 8, 0.70);
-- Máquina 14
INSERT INTO COMPARTIMENTO VALUES (18, 14, 'E1', 25, 60, 12, 1.50);
INSERT INTO COMPARTIMENTO VALUES (19, 14, 'E2', 10, 30, 6, 4.00);
-- Máquina 15
INSERT INTO COMPARTIMENTO VALUES (20, 15, 'F1', 18, 50, 10, 0.70);
INSERT INTO COMPARTIMENTO VALUES (21, 15, 'F2', 12, 30, 6, 1.80);



-- Inserir relações ESTA_NUM
-- Máquina 13
INSERT INTO ESTA_NUM VALUES (13, 13);
INSERT INTO ESTA_NUM VALUES (14, 14);
-- Máquina 14
INSERT INTO ESTA_NUM VALUES (15, 13);
INSERT INTO ESTA_NUM VALUES (16, 15);
-- Máquina 15
INSERT INTO ESTA_NUM VALUES (17, 14);
INSERT INTO ESTA_NUM VALUES (18, 16);

-- Inserir relações POSSUI 
-- Máquina 13
INSERT INTO POSSUI VALUES (13, 13, 20, 25); 
INSERT INTO POSSUI VALUES (13, 14, 15, 20);
-- Máquina 14
INSERT INTO POSSUI VALUES (14, 13, 25, 30); 
INSERT INTO POSSUI VALUES (14, 15, 10, 15); 
-- Máquina 15
INSERT INTO POSSUI VALUES (15, 14, 18, 25); 
INSERT INTO POSSUI VALUES (15, 16, 12, 15);

-- Inserir reposições
INSERT INTO VISITA VALUES (13, NULL, NULL, 13, 'Reabastecimento', 5, TO_DATE('2025-03-17 10:00:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO VISITA VALUES (14, NULL, NULL, 14, 'Reabastecimento', 8, TO_DATE('2025-03-17 11:00:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO VISITA VALUES (15, NULL, NULL, 15, 'Reabastecimento', 10, TO_DATE('2025-03-17 12:00:00', 'YYYY-MM-DD HH24:MI:SS'));


-- Inserir vendas
INSERT INTO VENDA VALUES (13, 16, 13, 13, TO_DATE('2025-03-12 09:00:00', 'YYYY-MM-DD HH24:MI:SS'), 1.50);
INSERT INTO VENDA VALUES (14, 16, 13, 13, TO_DATE('2025-03-18 10:00:00', 'YYYY-MM-DD HH24:MI:SS'), 1.50);
INSERT INTO VENDA VALUES (15, 16, 13, 13, TO_DATE('2025-03-19 11:00:00', 'YYYY-MM-DD HH24:MI:SS'), 1.50);
INSERT INTO VENDA VALUES (16, 17, 14, 13, TO_DATE('2025-03-14 08:30:00', 'YYYY-MM-DD HH24:MI:SS'), 0.70);

INSERT INTO VENDA VALUES (17, 18, 13, 14, TO_DATE('2025-03-11 07:45:00', 'YYYY-MM-DD HH24:MI:SS'), 1.50);
INSERT INTO VENDA VALUES (18, 18, 13, 14, TO_DATE('2025-03-19 13:15:00', 'YYYY-MM-DD HH24:MI:SS'), 1.50);
INSERT INTO VENDA VALUES (19, 19, 15, 14, TO_DATE('2025-03-15 12:30:00', 'YYYY-MM-DD HH24:MI:SS'), 4.00);

INSERT INTO VENDA VALUES (20, 20, 14, 15, TO_DATE('2025-03-13 11:45:00', 'YYYY-MM-DD HH24:MI:SS'), 0.70);
INSERT INTO VENDA VALUES (21, 20, 14, 15, TO_DATE('2025-03-19 14:00:00', 'YYYY-MM-DD HH24:MI:SS'), 0.70);
INSERT INTO VENDA VALUES (22, 20, 14, 15, TO_DATE('2025-03-20 16:00:00', 'YYYY-MM-DD HH24:MI:SS'), 0.70);
INSERT INTO VENDA VALUES (23, 21, 16, 15, TO_DATE('2025-03-15 17:30:00', 'YYYY-MM-DD HH24:MI:SS'), 1.80);



--CRIAR UMA FUNÇÃO QUE CALCULE A DISTANCIA ENTRE UMA MAQUINA E UM ARMAZEM
CREATE function  DISTANCIA_LINEAR (LAT1  NUMBER,LON1  NUMBER,LAT2  NUMBER,LON2  NUMBER) 
RETURN NUMBER
IS
    R NUMBER := 6371; -- Raio da Terra em Kms
    PI CONSTANT NUMBER := 3.141592653589793;
    D_LAT NUMBER ;
    D_LON NUMBER ;
    A NUMBER ;
    D NUMBER ;
BEGIN
    D_LAT := (LAT2 - LAT1) * PI / 180;
    D_LON := (LON2 - LON1) * PI / 180;
    A := SIN(D_LAT/2) * SIN(D_LAT/2) + COS(LAT1*PI/180) * COS(LAT2*PI/180) * SIN(D_LON/2) * SIN(D_LON/2);
    D := R * (2 * ATAN2(SQRT(A), SQRT(1 - A)));
    RETURN ROUND(D,3);
END;        
/  

--CRIAR UMA FUNCAO PARA IR BUSCAR A ULTIMA VEZ QUE A MAQUINA FOI ABASTECIDA
CREATE OR REPLACE FUNCTION ULTIMA_REPOSICAO (VID_MAQUINA NUMBER) RETURN DATE IS
    DATA DATE;
BEGIN
    SELECT MAX(DATA_REPOSICAO) INTO DATA FROM REPOSICAO R, COMPARTIMENTO C WHERE R.ID_COMPARTIMENTO = C.ID_COMPARTIMENTO
    AND C.ID_MAQUINA = VID_MAQUINA;
    RETURN DATA;
END;

--CRIAR UMA FUNCAO QUE ME DEVOLVA A QUANTIDADE TOTAL DE PRODUTOS QUE A MAQUINA TEM
CREATE OR REPLACE FUNCTION QUANTIDADE_TOTAL_PRODUTOS (VID_MAQUINA NUMBER) RETURN NUMBER IS
    TOTAL NUMBER;
BEGIN
    SELECT SUM(QUANT_EM_STOCK) INTO TOTAL 
    FROM POSSUI 
    WHERE ID_MAQUINA = VID_MAQUINA;
    RETURN TOTAL;
END;


--CRIAR UMA VIEW_D QUE OBTENHA AS MAQUINAS LOCALIZADAS NUM RAIO DE 30KM DO ARMAZEM LOCALIZADO EM TAVEIRO
--ESTA MAQUINA TEM DE TER KITKAT.
--MOSTRA-SE A DATA DO ULTIMO ABASTECIMENTO DESSA MAQUINA E A QUANTIDADE TOTAL DE PRODUTOS QUE POSSUI.

CREATE OR REPLACE VIEW VIEW_D AS
    SELECT
        M.ID_MAQUINA AS MAQUINAID,
        M.DESIGNACAO AS  LOCAL,
        DISTANCIA_LINEAR(M.LATITUDE, M.LONGITUDE,A.LATITUDE, A.LONGITUDE) AS   DISTANCIA_LINEAR,
        ULTIMA_REPOSICAO(M.ID_MAQUINA) AS DATA_ULT_ABAST,
        QUANTIDADE_TOTAL_PRODUTOS(M.ID_MAQUINA) AS QUANT_TOTAL_PRODUTOS 
    FROM
    MAQUINA M
    JOIN ARMAZEM A ON A.LOCALIZACAO LIKE '%Taveiro%'
    JOIN POSSUI P ON M.ID_MAQUINA = P.ID_MAQUINA
    JOIN PRODUTO PR ON P.ID_PRODUTO = PR.ID_PRODUTO
    WHERE
        PR.NOME = 'KitKat'
        AND DISTANCIA_LINEAR(M.LATITUDE, M.LONGITUDE,A.LATITUDE, A.LONGITUDE) <=30
    ORDER BY 
        DISTANCIA_LINEAR ASC;



-- Inserir Armazém em Taveiro
INSERT INTO ARMAZEM (ID_ARMAZEM, LOCALIZACAO, LATITUDE, LONGITUDE)
VALUES (11, 'Taveiro', 40.091667, -8.617500);

-- Inserir Máquinas 
INSERT INTO MAQUINA (ID_MAQUINA, DESIGNACAO, LOCALIZACAO, LATITUDE, LONGITUDE, STATUS)
VALUES (16, 'Máquina 16', 'Coimbra', 40.2100, -8.4100, 'Ativa');  

INSERT INTO MAQUINA (ID_MAQUINA, DESIGNACAO, LOCALIZACAO, LATITUDE, LONGITUDE, STATUS)
VALUES (17, 'Máquina 17', 'Montemor-o-Velho', 40.2167, -8.5967, 'Ativa'); 

INSERT INTO MAQUINA (ID_MAQUINA, DESIGNACAO, LOCALIZACAO, LATITUDE, LONGITUDE, STATUS)
VALUES (18, 'Máquina 18', 'Pombal', 39.9733, -8.6183, 'Inativa');  




INSERT INTO PRODUTO (ID_PRODUTO, NOME, PRECO_MEDIO, UNIDADES_VENDIDAS, QUANT_EM_MAQUINAS, 
                     QUANT_EM_STOCK, CAPACIDADE_MAX_COMPARTIMENTO, TIPO)  
VALUES (20, 'KiKat', 1.00, 100, 50, 200, 500, 'Chocolate');


-- Inserir Relação Possui para as Máquinas com o produto KitKat
INSERT INTO POSSUI (ID_MAQUINA, ID_PRODUTO, QUANT_EM_STOCK)
VALUES (16, 20, 20); -- Máquina 16 tem 20 KitKats

INSERT INTO POSSUI (ID_MAQUINA, ID_PRODUTO, QUANT_EM_STOCK)
VALUES (17, 20, 15); -- Máquina 17 tem 15 KitKats

INSERT INTO POSSUI (ID_MAQUINA, ID_PRODUTO, QUANT_EM_STOCK)
VALUES (18, 20, 0); -- Máquina 18 tem 0 KitKats (não entra na VIEW_D por não ter KitKat)


-- Inserir dados na tabela VISITA 
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_RECLAMACAO, ID_MAQUINA, MOTIVO, DISTANCIA)
VALUES (16, NULL, NULL, 16, 'Reabastecimento', 10);

INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_RECLAMACAO, ID_MAQUINA, MOTIVO, DISTANCIA)
VALUES (17, NULL, NULL, 17, 'Reabastecimento', 15);

-- Inserir dados na tabela REPOSICAO com ID_VISITA
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO)
VALUES (40, 22, 20, 16, 24, TRUNC(SYSDATE) - 1);

INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO)
VALUES (41, 22, 20, 17, 15, TRUNC(SYSDATE) - 1);

UPDATE MAQUINA
SET 
    LONGITUDE = (SELECT LONGITUDE FROM ARMAZEM WHERE LOCALIZACAO LIKE '%Taveiro%'),
    LATITUDE = (SELECT LATITUDE FROM ARMAZEM WHERE LOCALIZACAO LIKE '%Taveiro%')
WHERE ID_MAQUINA = 17;

--CRIAR VIEW AUXILIAR PARA CALCULAR AS VENDAS DE CADA PORDUTO POR MES E ANO (2023, 2024)
CREATE OR REPLACE VIEW VIEW_VENDAS_PRODUTO AS
    SELECT 
        P.TIPO,
        EXTRACT(MONTH FROM DATA_HORA) AS MES,
        EXTRACT(YEAR FROM DATA_HORA) AS ANO,
        COUNT(*) AS TOTAL_VENDAS
    FROM VENDA V
    JOIN PRODUTO P ON V.ID_PRODUTO=P.ID_PRODUTO
    WHERE EXTRACT(YEAR FROM DATA_HORA) IN (2023, 2024)
    GROUP BY P.TIPO, EXTRACT(MONTH FROM DATA_HORA), EXTRACT(YEAR FROM DATA_HORA);

--CRIAR UMA VIEW AUXILIAR PARA OBTER AS MAQUINAS COM O NUMERO DE REABASTECIMENTOS ACIMA DA MEDIA
CREATE OR REPLACE VIEW VIEW_MAQUINAS_REABASTECIDAS AS
    SELECT C.ID_MAQUINA
    FROM REPOSICAO R
    JOIN COMPARTIMENTO C ON R.ID_COMPARTIMENTO = C.ID_COMPARTIMENTO
    GROUP BY C.ID_MAQUINA
    HAVING COUNT(*) > (SELECT AVG(REABASTECIMENTOS) 
                       FROM (SELECT COUNT(*) AS REABASTECIMENTOS 
                             FROM REPOSICAO R 
                             JOIN COMPARTIMENTO C ON R.ID_COMPARTIMENTO = C.ID_COMPARTIMENTO 
                             GROUP BY C.ID_MAQUINA));

--CRIAR VIEW_E QUE PARA 2023 E 2024 OBTENHA A MEDIA DE QUANT VENDIDA EM CADA MES
-- SO DEVEM SER CONSIDERADAS MAQUINA OPERACIONAIS E COM UM NUMEDO DE REABASTECIMENTOS ACIMA DA MEDIA.

CREATE OR REPLACE VIEW VIEW_E AS
    SELECT 
        M.ID_MAQUINA AS IDMAQUINA,
        P.TIPO AS PRODUTO,
        ROUND(AVG(V.TOTAL_VENDAS), 2) AS MEDIAMENSAL
    FROM VIEW_VENDAS_PRODUTO V
    JOIN PRODUTO P ON V.TIPO = P.TIPO
    JOIN VENDA VN ON EXTRACT(MONTH FROM VN.DATA_HORA) = V.MES 
                     AND EXTRACT(YEAR FROM VN.DATA_HORA) = V.ANO
    JOIN MAQUINA M ON VN.ID_MAQUINA = M.ID_MAQUINA
    WHERE 
        M.STATUS = 'Ativa'  -- Apenas máquinas ativas
        AND M.ID_MAQUINA IN (SELECT ID_MAQUINA FROM VIEW_MAQUINAS_REABASTECIDAS) 
    GROUP BY M.ID_MAQUINA , P.TIPO, EXTRACT(MONTH FROM DATA_HORA), EXTRACT(YEAR FROM DATA_HORA)
    ORDER BY MEDIAMENSAL DESC, P.TIPO;




INSERT INTO MAQUINA (ID_MAQUINA, DESIGNACAO, LOCALIZACAO, STATUS) 
VALUES (16, 'Máquina 16', 'Coimbra', 'Ativa');

INSERT INTO MAQUINA (ID_MAQUINA, DESIGNACAO, LOCALIZACAO, STATUS) 
VALUES (17, 'Máquina 17', 'Taveiro', 'Ativa');

INSERT INTO MAQUINA (ID_MAQUINA, DESIGNACAO, LOCALIZACAO, STATUS) 
VALUES (18, 'Máquina 18', 'Montemor', 'Ativa');

INSERT INTO PRODUTO (ID_PRODUTO, NOME, TIPO) 
VALUES (17, 'KitKat', 'Chocolate');

INSERT INTO PRODUTO (ID_PRODUTO, NOME, TIPO) 
VALUES (18, 'Lays', 'Snacks');

INSERT INTO PRODUTO (ID_PRODUTO, NOME, TIPO) 
VALUES (19, 'Coca-Cola', 'Bebidas');

INSERT INTO COMPARTIMENTO (ID_COMPARTIMENTO, ID_MAQUINA, CODIGO_COMPARTIMENTO, QUANTIDADE_ATUAL, CAPACIDADE_MAX, QUANTIDADE_MINIMA, PRECO) 
VALUES (24, 16, 'A1', 10, 50, 5, 1.50);

INSERT INTO COMPARTIMENTO (ID_COMPARTIMENTO, ID_MAQUINA, CODIGO_COMPARTIMENTO, QUANTIDADE_ATUAL, CAPACIDADE_MAX, QUANTIDADE_MINIMA, PRECO) 
VALUES (22, 17, 'B1', 15, 50, 5, 1.75);

INSERT INTO COMPARTIMENTO (ID_COMPARTIMENTO, ID_MAQUINA, CODIGO_COMPARTIMENTO, QUANTIDADE_ATUAL, CAPACIDADE_MAX, QUANTIDADE_MINIMA, PRECO) 
VALUES (23, 18, 'C1', 20, 50, 5, 2.00);


INSERT INTO ARMAZEM (ID_ARMAZEM, LOCALIZACAO, LATITUDE, LONGITUDE)
VALUES (12, 'Portimão', 10.091667, -18.617500);

INSERT INTO ROTA VALUES (11, 12, 'Rota Praia da Rocha', 80);

INSERT INTO FUNCIONARIO VALUES (11, 'Cristiano Ronaldo', 930777777);

INSERT INTO VEICULO VALUES (11, 'CR-77-CR', 2200, 777, 'Pegeout', 'CR77');

INSERT INTO VIAGEM VALUES (2025040311, 11, 11, 11, TO_DATE('2025-04-03 11:00:00', 'YYYY-MM-DD HH24:MI:SS'),
                          TO_DATE('2025-04-03 18:00:00', 'YYYY-MM-DD HH24:MI:SS'),
                          100);

INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_RECLAMACAO, ID_MAQUINA, MOTIVO, DISTANCIA, DATA_VISITA) 
VALUES (19, 2025040311, NULL, 16, 'Reabastecimento', 12.5, TO_DATE('2024-03-01', 'YYYY-MM-DD'));

INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_RECLAMACAO, ID_MAQUINA, MOTIVO, DISTANCIA, DATA_VISITA) 
VALUES (17, 2025040311, NULL, 17, 'Reabastecimento', 15.2, TO_DATE('2024-03-15', 'YYYY-MM-DD'));

INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_RECLAMACAO, ID_MAQUINA, MOTIVO, DISTANCIA, DATA_VISITA) 
VALUES (18, 2025040311, NULL, 18, 'Reabastecimento', 18.7, TO_DATE('2024-02-10', 'YYYY-MM-DD'));

INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO) 
VALUES (8, 24, 19, 19, 30, TO_DATE('2024-02-10', 'YYYY-MM-DD'));

INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO) 
VALUES (7, 24, 19, 19, 30, TO_DATE('2024-02-10', 'YYYY-MM-DD'));

INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO) 
VALUES (18, 24, 19, 19, 30, TO_DATE('2024-02-10', 'YYYY-MM-DD'));

INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO) 
VALUES (16, 22, 17, 17, 20, TO_DATE('2024-03-01', 'YYYY-MM-DD'));

INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO) 
VALUES (17, 23, 18, 18, 25, TO_DATE('2024-03-15', 'YYYY-MM-DD'));

INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO) 
VALUES (20, 24, 19, 19, 30, TO_DATE('2024-02-10', 'YYYY-MM-DD'));

INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO) 
VALUES (21, 24, 19, 19, 30, TO_DATE('2024-02-10', 'YYYY-MM-DD'));

INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO) 
VALUES (22, 24, 19, 19, 30, TO_DATE('2024-02-10', 'YYYY-MM-DD'));

INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO) 
VALUES (23, 24, 19, 19, 30, TO_DATE('2024-02-10', 'YYYY-MM-DD'));

INSERT INTO VENDA (ID_VENDA, ID_COMPARTIMENTO, ID_PRODUTO, ID_MAQUINA, DATA_HORA, PRECO) 
VALUES (24, 22, 17, 16, TO_DATE('2024-03-02 14:30', 'YYYY-MM-DD HH24:MI'), 1.75);

INSERT INTO VENDA (ID_VENDA, ID_COMPARTIMENTO, ID_PRODUTO, ID_MAQUINA, DATA_HORA, PRECO) 
VALUES (25, 23, 18, 17, TO_DATE('2024-03-16 09:45', 'YYYY-MM-DD HH24:MI'), 2.00);

INSERT INTO VENDA (ID_VENDA, ID_COMPARTIMENTO, ID_PRODUTO, ID_MAQUINA, DATA_HORA, PRECO) 
VALUES (26, 24, 19, 18, TO_DATE('2024-02-11 17:20', 'YYYY-MM-DD HH24:MI'), 1.50);

INSERT INTO VENDA (ID_VENDA, ID_COMPARTIMENTO, ID_PRODUTO, ID_MAQUINA, DATA_HORA, PRECO) 
VALUES (27, 23, 17, 16, TO_DATE('2023-12-25 13:10', 'YYYY-MM-DD HH24:MI'), 2.00);

INSERT INTO VENDA (ID_VENDA, ID_COMPARTIMENTO, ID_PRODUTO, ID_MAQUINA, DATA_HORA, PRECO) 
VALUES (28, 22, 18, 17, TO_DATE('2023-11-05 10:30', 'YYYY-MM-DD HH24:MI'), 1.75);

INSERT INTO VENDA (ID_VENDA, ID_COMPARTIMENTO, ID_PRODUTO, ID_MAQUINA, DATA_HORA, PRECO) 
VALUES (40, 22, 17, 16, TO_DATE('2024-03-02 14:30', 'YYYY-MM-DD HH24:MI'), 1.75);

INSERT INTO VENDA (ID_VENDA, ID_COMPARTIMENTO, ID_PRODUTO, ID_MAQUINA, DATA_HORA, PRECO) 
VALUES (41, 23, 18, 17, TO_DATE('2024-03-16 09:45', 'YYYY-MM-DD HH24:MI'), 2.00);

INSERT INTO VENDA (ID_VENDA, ID_COMPARTIMENTO, ID_PRODUTO, ID_MAQUINA, DATA_HORA, PRECO) 
VALUES (42, 24, 19, 18, TO_DATE('2024-02-11 17:20', 'YYYY-MM-DD HH24:MI'), 1.50);

INSERT INTO VENDA (ID_VENDA, ID_COMPARTIMENTO, ID_PRODUTO, ID_MAQUINA, DATA_HORA, PRECO) 
VALUES (43, 23, 17, 16, TO_DATE('2023-12-25 13:10', 'YYYY-MM-DD HH24:MI'), 2.00);

INSERT INTO VENDA (ID_VENDA, ID_COMPARTIMENTO, ID_PRODUTO, ID_MAQUINA, DATA_HORA, PRECO) 
VALUES (44, 22, 18, 17, TO_DATE('2023-11-05 10:30', 'YYYY-MM-DD HH24:MI'), 1.75);


--FUNCAO PARA CALCULAR O PESO DAS VENDAS DE UM PRODUTO EM RELACAO A MAQUINA
CREATE OR REPLACE FUNCTION CALCULAR_PERCENTAGEM_VENDAS( VID_MAQUINA NUMBER, VID_PRODUTO NUMBER,
VMES NUMBER, VANO NUMBER)
RETURN NUMBER IS
    PERCENTAGEM NUMBER;
BEGIN
    SELECT ROUND((COUNT(*) * 100) / 
                 (SELECT COUNT(*) 
                  FROM VENDA V2 
                  WHERE V2.ID_MAQUINA = VID_MAQUINA 
                    AND EXTRACT(MONTH FROM V2.DATA_HORA) = VMES
                    AND EXTRACT(YEAR FROM V2.DATA_HORA) = VANO), 2)
    INTO PERCENTAGEM
    FROM VENDA V
    WHERE V.ID_MAQUINA = VID_MAQUINA
      AND V.ID_PRODUTO = VID_PRODUTO
      AND EXTRACT(MONTH FROM V.DATA_HORA) = VMES
      AND EXTRACT(YEAR FROM V.DATA_HORA) = VANO;

    RETURN NVL(PERCENTAGEM, 0);
END;
/

--FUNCAO PARA CALCULAR A QUANTIDADE REABASTECIDA DE UM PRODUTO EM RELACAO A MAQUINA
CREATE OR REPLACE FUNCTION CALCULAR_QUANT_REPOSTA(VID_MAQUINA NUMBER, VID_PRODUTO NUMBER,
VMES NUMBER, VANO NUMBER)
RETURN NUMBER IS
    QUANT_REPOSTA NUMBER;
BEGIN
    SELECT NVL(SUM(R.QUANTIDADE_REPOSTA), 0)
    INTO QUANT_REPOSTA
    FROM REPOSICAO R
    JOIN COMPARTIMENTO C ON R.ID_COMPARTIMENTO = C.ID_COMPARTIMENTO
    WHERE C.ID_MAQUINA = VID_MAQUINA
    AND R.ID_PRODUTO = VID_PRODUTO
    AND EXTRACT(MONTH FROM R.DATA_REPOSICAO) = VMES
    AND EXTRACT(YEAR FROM R.DATA_REPOSICAO) = VANO;

    RETURN QUANT_REPOSTA;
END;
/

--FUNCAO PARA IR BUSCA A MAQUINA QUE MAIS PRODUTOS DE UM TIPO VENDEU 

CREATE OR REPLACE VIEW VIEW_F AS
SELECT 
    M.ID_MAQUINA AS IDMAQUINA,
    P.ID_PRODUTO AS REFPRODUTO,
    COUNT(V.ID_PRODUTO) AS QUANT_VENDIDA,
    CALCULAR_PERCENTAGEM_VENDAS(M.ID_MAQUINA, P.ID_PRODUTO, 2, EXTRACT(YEAR FROM SYSDATE)) AS PERCENTAGEM,
    CALCULAR_QUANT_REPOSTA(M.ID_MAQUINA, P.ID_PRODUTO, 2, EXTRACT(YEAR FROM SYSDATE)) AS QUANT_REABASTECIDA
FROM 
    VENDA V
JOIN PRODUTO P ON V.ID_PRODUTO = P.ID_PRODUTO
JOIN MAQUINA M ON V.ID_MAQUINA = M.ID_MAQUINA
WHERE 
    UPPER(P.TIPO) = 'AGUA' -- Apenas produtos do tipo 'AGUA'
    AND V.ID_MAQUINA = (
        SELECT ID_MAQUINA 
        FROM (
            SELECT V3.ID_MAQUINA, COUNT(*) AS TOTAL_VENDAS
            FROM VENDA V3
            JOIN PRODUTO P3 ON V3.ID_PRODUTO = P3.ID_PRODUTO
            WHERE P3.TIPO = 'AGUA' 
                AND V3.DATA_HORA >= SYSDATE - 3 -- Últimas 72 horas
            GROUP BY V3.ID_MAQUINA
            ORDER BY TOTAL_VENDAS DESC
        ) WHERE ROWNUM = 1
    ) 
    AND (EXTRACT(MONTH FROM V.DATA_HORA) = 2 OR V.ID_MAQUINA IS NOT NULL) -- Ajuste para evitar filtro vazio
    AND EXTRACT(YEAR FROM V.DATA_HORA) = EXTRACT(YEAR FROM SYSDATE) -- Ano atual
GROUP BY 
    M.ID_MAQUINA, P.ID_PRODUTO
ORDER BY 
    QUANT_VENDIDA DESC;





-- Inserir máquinas
INSERT INTO MAQUINA (ID_MAQUINA) VALUES (30);
INSERT INTO MAQUINA (ID_MAQUINA) VALUES (31);

-- Inserir produtos do tipo 'AGUA'
INSERT INTO PRODUTO (ID_PRODUTO, TIPO) VALUES (30, 'AGUA');
INSERT INTO PRODUTO (ID_PRODUTO, TIPO) VALUES (31, 'AGUA');

-- Inserir compartimentos para as máquinas
INSERT INTO COMPARTIMENTO (ID_COMPARTIMENTO, ID_MAQUINA) VALUES (30, 30);
INSERT INTO COMPARTIMENTO (ID_COMPARTIMENTO, ID_MAQUINA) VALUES (31, 31);

-- Inserir reabastecimento para fevereiro
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, DATA_REPOSICAO, QUANTIDADE_REPOSTA) 
VALUES (30, 30, 30, TO_DATE('2024-02-10', 'YYYY-MM-DD'), 100);
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, DATA_REPOSICAO, QUANTIDADE_REPOSTA) 
VALUES (31, 31, 31, TO_DATE('2024-02-15', 'YYYY-MM-DD'), 120);

-- Inserir vendas nos últimos 72h e em fevereiro
INSERT INTO VENDA (ID_VENDA, ID_MAQUINA, ID_PRODUTO, DATA_HORA) 
VALUES (30, 30, 30, SYSDATE - 2);
INSERT INTO VENDA (ID_VENDA, ID_MAQUINA, ID_PRODUTO, DATA_HORA) 
VALUES (31, 30, 30, TO_DATE('2024-02-05', 'YYYY-MM-DD'));
INSERT INTO VENDA (ID_VENDA, ID_MAQUINA, ID_PRODUTO, DATA_HORA) 
VALUES (32, 30, 30, TO_DATE('2024-02-20', 'YYYY-MM-DD'));
INSERT INTO VENDA (ID_VENDA, ID_MAQUINA, ID_PRODUTO, DATA_HORA) 
VALUES (33, 31, 31, TO_DATE('2024-02-18', 'YYYY-MM-DD'));


UPDATE VENDA
SET DATA_HORA = SYSDATE - DBMS_RANDOM.VALUE(0, 3) -- Define datas entre agora e 72h atrás
WHERE ID_PRODUTO IN (SELECT ID_PRODUTO FROM PRODUTO WHERE UPPER(TIPO) = 'AGUA');

CREATE OR REPLACE VIEW VIEW_G AS
SELECT 
    V.ID_VIAGEM AS VIAGEM,
    P.TIPO AS TIPO_PRODUTO,
    SUM(R.QUANTIDADE_REPOSTA) AS QUANT_ABASTECIDA,
    COUNT(DISTINCT C.ID_MAQUINA) AS NUM_MAQ_ABASTECIDAS
FROM REPOSICAO R
JOIN COMPARTIMENTO C ON R.ID_COMPARTIMENTO = C.ID_COMPARTIMENTO
JOIN PRODUTO P ON R.ID_PRODUTO = P.ID_PRODUTO
JOIN VISITA VS ON R.ID_VISITA = VS.ID_VISITA
JOIN VIAGEM V ON VS.ID_VIAGEM = V.ID_VIAGEM
JOIN MAQUINA M ON C.ID_MAQUINA = M.ID_MAQUINA
WHERE 
    EXTRACT(YEAR FROM R.DATA_REPOSICAO) = EXTRACT(YEAR FROM SYSDATE) - 1 -- Ano passado
    AND M.LOCALIZACAO LIKE '%Coimbra%' -- Apenas máquinas de Coimbra
    AND VS.MOTIVO LIKE '%REPOSICAO%' -- Apenas visitas que foram reabastecimento
GROUP BY V.ID_VIAGEM, P.TIPO
HAVING COUNT(DISTINCT C.ID_MAQUINA) > 3 -- Apenas viagens que reabasteceram mais de 3 máquinas
ORDER BY SUM(R.QUANTIDADE_REPOSTA) DESC; -- Ordenação pelo volume total de pedidos entregues



-- Inserção de ARMAZEM (ID a partir de 32)
INSERT INTO ARMAZEM (ID_ARMAZEM, LOCALIZACAO, DESIGNACAO, LATITUDE, LONGITUDE) 
VALUES (32, 'Coimbra', 'Armazém Sul', 40.203314, -8.410257);

-- Inserção de MAQUINAS em Coimbra (4 máquinas para uma viagem >3)
INSERT INTO MAQUINA (ID_MAQUINA, LOCALIZACAO, DESIGNACAO, LATITUDE, LONGITUDE, STATUS) 
VALUES (32, 'Coimbra - Centro', 'Máquina A', 40.211805, -8.429230, 'Ativa');
INSERT INTO MAQUINA (ID_MAQUINA, LOCALIZACAO, DESIGNACAO, LATITUDE, LONGITUDE, STATUS) 
VALUES(33, 'Coimbra - Solum', 'Máquina B', 40.207472, -8.416803, 'Ativa');
INSERT INTO MAQUINA (ID_MAQUINA, LOCALIZACAO, DESIGNACAO, LATITUDE, LONGITUDE, STATUS) 
VALUES(34, 'Coimbra - Celas', 'Máquina C', 40.215621, -8.412456, 'Ativa');
INSERT INTO MAQUINA (ID_MAQUINA, LOCALIZACAO, DESIGNACAO, LATITUDE, LONGITUDE, STATUS) 
VALUES(35, 'Coimbra - Santa Clara', 'Máquina D', 40.199876, -8.434567, 'Ativa');

-- Inserção de COMPARTIMENTOS para cada máquina (1 compartimento por máquina)
INSERT INTO COMPARTIMENTO (ID_COMPARTIMENTO, ID_MAQUINA, CODIGO_COMPARTIMENTO, CAPACIDADE_MAX, QUANTIDADE_MINIMA)
VALUES 
(32, 32, 'C1', 100, 10);
INSERT INTO COMPARTIMENTO (ID_COMPARTIMENTO, ID_MAQUINA, CODIGO_COMPARTIMENTO, CAPACIDADE_MAX, QUANTIDADE_MINIMA)
VALUES (33, 33, 'C1', 100, 10);
INSERT INTO COMPARTIMENTO (ID_COMPARTIMENTO, ID_MAQUINA, CODIGO_COMPARTIMENTO, CAPACIDADE_MAX, QUANTIDADE_MINIMA)
VALUES (34, 34, 'C1', 100, 10);
INSERT INTO COMPARTIMENTO (ID_COMPARTIMENTO, ID_MAQUINA, CODIGO_COMPARTIMENTO, CAPACIDADE_MAX, QUANTIDADE_MINIMA)
VALUES (35, 35, 'C1', 100, 10);

-- Inserção de PRODUTOS (IDs 32 e 33 como tipos mais frequentes)
INSERT INTO PRODUTO (ID_PRODUTO, TIPO, NOME, PRECO_MEDIO) 
VALUES 
(32, 'Snack', 'Batatas Fritas', 1.50);
INSERT INTO PRODUTO (ID_PRODUTO, TIPO, NOME, PRECO_MEDIO) 
VALUES (33, 'Bebida', 'Água 500ml', 1.00);
INSERT INTO PRODUTO (ID_PRODUTO, TIPO, NOME, PRECO_MEDIO) 
VALUES (34, 'Doce', 'Chocolate', 2.00);

-- Inserção de ROTA (vinculada ao armazém 32)
INSERT INTO ROTA (ID_ROTA, ID_ARMAZEM, NOME_ROTA, DISTANCIA_KM) 
VALUES (32, 32, 'Coimbra Sul', 15);

-- Inserção de VEICULO (para viagem)
INSERT INTO VEICULO (ID_VEICULO, MATRICULA, CAPACIDADE_CARGA, AUTONOMIA_KM) 
VALUES (32, 'CC-17-BA', 500, 300);

-- Inserção de FUNCIONARIO (motorista)
INSERT INTO FUNCIONARIO (ID_FUNCIONARIO, NOME, CONTACTO) 
VALUES (32, 'Paulo Viera', 930222666);

-- Inserção de VIAGEM (ano passado, vinculada à rota 32)
INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, ID_VEICULO, ID_FUNCIONARIO, DATA_HORA_INICIO, DATA_HORA_FIM)
VALUES (
    32, 
    32, 
    32, 
    32, 
    TO_DATE('2024-05-10 08:00', 'YYYY-MM-DD HH24:MI'),  -- Ano 2024
    TO_DATE('2024-05-10 12:00', 'YYYY-MM-DD HH24:MI')
);

-- Atualização das VISITAS para 2024
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA) 
VALUES 
(32, 32, 32, 'REPOSICAO', TO_DATE('2024-05-10 09:00', 'YYYY-MM-DD HH24:MI'));
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA) 
VALUES(33, 32, 33, 'REPOSICAO', TO_DATE('2024-05-10 09:30', 'YYYY-MM-DD HH24:MI'));
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA) 
VALUES(34, 32, 34, 'REPOSICAO', TO_DATE('2024-05-10 10:00', 'YYYY-MM-DD HH24:MI'));
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA) 
VALUES(35, 32, 35, 'REPOSICAO', TO_DATE('2024-05-10 10:30', 'YYYY-MM-DD HH24:MI'));

-- Atualização das REPOSIÇÕES para 2024
-- Máquina 32
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO)
VALUES (32, 32, 32, 32, 50, TO_DATE('2024-06-11', 'YYYY-MM-DD'));
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO)
VALUES (33, 32, 33, 32, 30, TO_DATE('2024-05-12', 'YYYY-MM-DD'));
-- Máquina 33
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO)
VALUES (34, 33, 32, 33, 45, TO_DATE('2024-05-24', 'YYYY-MM-DD')); 
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO)
VALUES (35, 33, 33, 33, 25, TO_DATE('2024-07-16', 'YYYY-MM-DD'));
-- Máquina 34
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO)
VALUES (36, 34, 32, 34, 40, TO_DATE('2024-08-12', 'YYYY-MM-DD')); 
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO)
VALUES (37, 34, 33, 34, 20, TO_DATE('2024-10-10', 'YYYY-MM-DD'));
-- Máquina 35
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO)
VALUES (38, 35, 32, 35, 35, TO_DATE('2024-09-23', 'YYYY-MM-DD'));
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO)
VALUES (39, 35, 33, 35, 15, TO_DATE('2024-12-18', 'YYYY-MM-DD'));

CREATE OR REPLACE VIEW VIEW_H AS
SELECT * FROM (
    SELECT 
        V.MATRICULA, 
        V.MARCA, 
        V.MODELO, 
        COUNT(DISTINCT VI.ID_MAQUINA) AS N_MAQUINAS_REABASTE -- Contamos as máquinas reabastecidas
    FROM VIAGEM TV
    JOIN VEICULO V ON TV.ID_VEICULO = V.ID_VEICULO
    JOIN VISITA VI ON TV.ID_VIAGEM = VI.ID_VIAGEM
    JOIN REPOSICAO R ON VI.ID_VISITA = R.ID_VISITA
    JOIN COMPARTIMENTO C ON R.ID_COMPARTIMENTO = C.ID_COMPARTIMENTO
    JOIN ESTA_NUM E ON E.ID_COMPARTIMENTO = C.ID_COMPARTIMENTO
    JOIN PRODUTO P ON E.ID_PRODUTO = P.ID_PRODUTO
    WHERE 
        EXTRACT(MONTH FROM TV.DATA_HORA_FIM) = EXTRACT(MONTH FROM SYSDATE) - 1  -- Mês passado
        AND EXTRACT(YEAR FROM TV.DATA_HORA_FIM) = EXTRACT(YEAR FROM SYSDATE)    -- Mesmo ano
        AND TV.DISTANCIA_KM > 50  -- Apenas viagens superiores a 50 km
        AND UPPER(P.TIPO) = 'AGUA'  -- Apenas produtos do tipo AGUA
        AND UPPER(VI.MOTIVO) LIKE '%REPOSICAO%'  -- Apenas visitas que tenham motivo "REPOSIÇÃO"
    GROUP BY V.MATRICULA, V.MARCA, V.MODELO
    HAVING COUNT(DISTINCT VI.ID_MAQUINA) >= 3 -- Apenas máquinas reabastecidas mais de 3 vezes
    ORDER BY COUNT(DISTINCT TV.ID_VIAGEM) DESC -- Ordenação pelo número de viagens
) WHERE ROWNUM <= 5; -- Pegamos apenas os 5 veículos mais utilizados

INSERT INTO PRODUTO (
    ID_PRODUTO, 
    TIPO, 
    NOME, 
    PRECO_MEDIO, 
    UNIDADES_VENDIDAS, 
    QUANT_EM_MAQUINAS, 
    QUANT_EM_STOCK, 
    CAPACIDADE_MAX_COMPARTIMENTO
) VALUES (
    38, 
    'AGUA', 
    'Água Mineral', 
    1.20, 
    1000, 
    500, 
    2000, 
    200
);
--MAQUINAS (4 máquinas)
INSERT INTO MAQUINA (
    ID_MAQUINA, 
    LOCALIZACAO, 
    DESIGNACAO, 
    LATITUDE, 
    LONGITUDE, 
    STATUS, 
    DATA_HORA_ULTIMO_REPORT, 
    DATA_HORA_ULTIMA_VISITA
) VALUES (
    38, 
    'Lisboa - Parque das Nações', 
    'Máquina H2O-1', 
    38.7696, 
    -9.0958, 
    'ATIVA', 
    SYSDATE - 1, 
    SYSDATE - 2
);

INSERT INTO MAQUINA (
    ID_MAQUINA, 
    LOCALIZACAO, 
    DESIGNACAO, 
    LATITUDE, 
    LONGITUDE, 
    STATUS, 
    DATA_HORA_ULTIMO_REPORT, 
    DATA_HORA_ULTIMA_VISITA
) VALUES (
    39, 
    'Lisboa - Alfama', 
    'Máquina H2O-2', 
    38.7105, 
    -9.1293, 
    'ATIVA', 
    SYSDATE - 1, 
    SYSDATE - 3
);

INSERT INTO MAQUINA (
    ID_MAQUINA, 
    LOCALIZACAO, 
    DESIGNACAO, 
    LATITUDE, 
    LONGITUDE, 
    STATUS, 
    DATA_HORA_ULTIMO_REPORT, 
    DATA_HORA_ULTIMA_VISITA
) VALUES (
    40, 
    'Lisboa - Chiado', 
    'Máquina H2O-3', 
    38.7109, 
    -9.1426, 
    'ATIVA', 
    SYSDATE - 1, 
    SYSDATE - 4
);

INSERT INTO MAQUINA (
    ID_MAQUINA, 
    LOCALIZACAO, 
    DESIGNACAO, 
    LATITUDE, 
    LONGITUDE, 
    STATUS, 
    DATA_HORA_ULTIMO_REPORT, 
    DATA_HORA_ULTIMA_VISITA
) VALUES (
    41, 
    'Lisboa - Belém', 
    'Máquina H2O-4', 
    38.6976, 
    -9.2066, 
    'ATIVA', 
    SYSDATE - 1, 
    SYSDATE - 5
);
INSERT INTO ARMAZEM (
    ID_ARMAZEM, 
    LOCALIZACAO, 
    DESIGNACAO, 
    LATITUDE, 
    LONGITUDE
) VALUES (
    38, 
    'Lisboa', 
    'Armazém Norte', 
    38.7223, 
    -9.1393
);


--COMPARTIMENTOS (associados às máquinas)
INSERT INTO COMPARTIMENTO (
    ID_COMPARTIMENTO, 
    ID_MAQUINA, 
    CODIGO_COMPARTIMENTO, 
    QUANTIDADE_ATUAL, 
    CAPACIDADE_MAX, 
    QUANTIDADE_MINIMA, 
    PRECO
) VALUES (
    38, 
    38, 
    'AGUA-1', 
    150, 
    200, 
    20, 
    1.20
);

INSERT INTO COMPARTIMENTO (
    ID_COMPARTIMENTO, 
    ID_MAQUINA, 
    CODIGO_COMPARTIMENTO, 
    QUANTIDADE_ATUAL, 
    CAPACIDADE_MAX, 
    QUANTIDADE_MINIMA, 
    PRECO
) VALUES (
    39, 
    39, 
    'AGUA-1', 
    180, 
    200, 
    20, 
    1.20
);

INSERT INTO COMPARTIMENTO (
    ID_COMPARTIMENTO, 
    ID_MAQUINA, 
    CODIGO_COMPARTIMENTO, 
    QUANTIDADE_ATUAL, 
    CAPACIDADE_MAX, 
    QUANTIDADE_MINIMA, 
    PRECO
) VALUES (
    40, 
    40, 
    'AGUA-1', 
    160, 
    200, 
    20, 
    1.20
);

INSERT INTO COMPARTIMENTO (
    ID_COMPARTIMENTO, 
    ID_MAQUINA, 
    CODIGO_COMPARTIMENTO, 
    QUANTIDADE_ATUAL, 
    CAPACIDADE_MAX, 
    QUANTIDADE_MINIMA, 
    PRECO
) VALUES (
    41, 
    41, 
    'AGUA-1', 
    170, 
    200, 
    20, 
    1.20
);

--ESTA_NUM (relaciona compartimentos ao produto 'AGUA')
INSERT INTO ESTA_NUM (
    ID_COMPARTIMENTO, 
    ID_PRODUTO
) VALUES 
(38, 38);
INSERT INTO ESTA_NUM (
    ID_COMPARTIMENTO, 
    ID_PRODUTO
) VALUES(39, 38);
INSERT INTO ESTA_NUM (
    ID_COMPARTIMENTO, 
    ID_PRODUTO
) VALUES(40, 38);
INSERT INTO ESTA_NUM (
    ID_COMPARTIMENTO, 
    ID_PRODUTO
) VALUES(41, 38);

--VEICULOS (5 veículos)
INSERT INTO VEICULO (
    ID_VEICULO, 
    MATRICULA, 
    MARCA, 
    MODELO, 
    CAPACIDADE_CARGA, 
    AUTONOMIA_KM
) VALUES (
    38, 
    'AA-38-AA', 
    'Mercedes', 
    'Sprinter', 
    1500, 
    500
);

INSERT INTO VEICULO (
    ID_VEICULO, 
    MATRICULA, 
    MARCA, 
    MODELO, 
    CAPACIDADE_CARGA, 
    AUTONOMIA_KM
) VALUES (
    39, 
    'BB-39-BB', 
    'Ford', 
    'Transit', 
    1200, 
    450 
);

INSERT INTO VEICULO (
    ID_VEICULO, 
    MATRICULA, 
    MARCA, 
    MODELO, 
    CAPACIDADE_CARGA, 
    AUTONOMIA_KM
) VALUES (
    40, 
    'CC-40-CC', 
    'Volkswagen', 
    'Crafter', 
    2000, 
    600
);

INSERT INTO VEICULO (
    ID_VEICULO, 
    MATRICULA, 
    MARCA, 
    MODELO, 
    CAPACIDADE_CARGA, 
    AUTONOMIA_KM
) VALUES (
    41, 
    'DD-41-DD', 
    'Renault', 
    'Master', 
    1000, 
    400
);

INSERT INTO VEICULO (
    ID_VEICULO, 
    MATRICULA, 
    MARCA, 
    MODELO, 
    CAPACIDADE_CARGA, 
    AUTONOMIA_KM
) VALUES (
    42, 
    'EE-42-EE', 
    'Iveco', 
    'Daily', 
    1800, 
    550
);

--ROTA (distância >50 km)
INSERT INTO ROTA (
    ID_ROTA, 
    ID_ARMAZEM, 
    NOME_ROTA, 
    DISTANCIA_KM
) VALUES (
    38, 
    38, 
    'Rota Água Lisboa', 
    60
);

--FUNCIONARIO
INSERT INTO FUNCIONARIO (
    ID_FUNCIONARIO, 
    NOME, 
    CONTACTO
) VALUES (
    38, 
    'Carlos Mendes', 
    912333888
);

-- VIAGENS (mês passado, >50 km)
-- Veículo 38
INSERT INTO VIAGEM (
    ID_VIAGEM, 
    ID_ROTA, 
    ID_VEICULO, 
    ID_FUNCIONARIO, 
    DATA_HORA_INICIO, 
    DATA_HORA_FIM, 
    DISTANCIA_KM
) VALUES (
    38, 
    38, 
    38, 
    38, 
    TO_DATE('2025-03-08 08:00', 'YYYY-MM-DD HH24:MI'), 
    TO_DATE('2025-03-08 12:00', 'YYYY-MM-DD HH24:MI'), 
    60
);

INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, ID_VEICULO, ID_FUNCIONARIO, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM) VALUES 
(39, 38, 38, 38, TO_DATE('2025-03-10 08:30', 'YYYY-MM-DD HH24:MI'), TO_DATE('2025-03-10 12:30', 'YYYY-MM-DD HH24:MI'), 65);
INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, ID_VEICULO, ID_FUNCIONARIO, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM) VALUES 
(40, 38, 38, 38, TO_DATE('2025-03-12 09:00', 'YYYY-MM-DD HH24:MI'), TO_DATE('2025-03-12 13:00', 'YYYY-MM-DD HH24:MI'), 70);
INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, ID_VEICULO, ID_FUNCIONARIO, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM) VALUES
(41, 38, 38, 38, TO_DATE('2025-03-14 09:30', 'YYYY-MM-DD HH24:MI'), TO_DATE('2025-03-14 13:30', 'YYYY-MM-DD HH24:MI'), 75);

-- Veículo 39
INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, ID_VEICULO, ID_FUNCIONARIO, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM) VALUES 
(42, 38, 39, 38, TO_DATE('2025-03-09 08:00', 'YYYY-MM-DD HH24:MI'), TO_DATE('2025-03-09 12:00', 'YYYY-MM-DD HH24:MI'), 62);
INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, ID_VEICULO, ID_FUNCIONARIO, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM) VALUES
(43, 38, 39, 38, TO_DATE('2025-03-11 08:30', 'YYYY-MM-DD HH24:MI'), TO_DATE('2025-03-11 12:30', 'YYYY-MM-DD HH24:MI'), 68);
INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, ID_VEICULO, ID_FUNCIONARIO, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM) VALUES
(44, 38, 39, 38, TO_DATE('2025-03-13 09:00', 'YYYY-MM-DD HH24:MI'), TO_DATE('2025-03-13 13:00', 'YYYY-MM-DD HH24:MI'), 72);
INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, ID_VEICULO, ID_FUNCIONARIO, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM) VALUES
(45, 38, 39, 38, TO_DATE('2025-03-15 09:30', 'YYYY-MM-DD HH24:MI'), TO_DATE('2025-03-15 13:30', 'YYYY-MM-DD HH24:MI'), 78);


-- Viagem 39 
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES 
(48, 39, 38, 'REPOSICAO', TO_DATE('2025-03-10 09:00', 'YYYY-MM-DD HH24:MI'), 5);
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES
(49, 39, 39, 'REPOSICAO', TO_DATE('2025-03-10 09:35', 'YYYY-MM-DD HH24:MI'), 7);
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES
(50, 39, 40, 'REPOSICAO', TO_DATE('2025-03-10 10:10', 'YYYY-MM-DD HH24:MI'), 9);
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES
(51, 39, 41, 'REPOSICAO', TO_DATE('2025-03-10 10:45', 'YYYY-MM-DD HH24:MI'), 6);

-- Viagem 40
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES 
(52, 40, 38, 'REPOSICAO', TO_DATE('2025-03-12 09:15', 'YYYY-MM-DD HH24:MI'), 4);
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES
(53, 40, 39, 'REPOSICAO', TO_DATE('2025-03-12 09:50', 'YYYY-MM-DD HH24:MI'), 8);
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES
(54, 40, 41, 'REPOSICAO', TO_DATE('2025-03-12 10:25', 'YYYY-MM-DD HH24:MI'), 11);

-- Viagem 41
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES 
(55, 41, 38, 'REPOSICAO', TO_DATE('2025-03-14 09:20', 'YYYY-MM-DD HH24:MI'), 6);
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES
(56, 41, 39, 'REPOSICAO', TO_DATE('2025-03-14 09:55', 'YYYY-MM-DD HH24:MI'), 5);
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES
(57, 41, 40, 'REPOSICAO', TO_DATE('2025-03-14 10:30', 'YYYY-MM-DD HH24:MI'), 7);
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES
(58, 41, 41, 'REPOSICAO', TO_DATE('2025-03-14 11:05', 'YYYY-MM-DD HH24:MI'), 9);

-- Viagem 42
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES 
(59, 42, 38, 'REPOSICAO', TO_DATE('2025-03-09 09:00', 'YYYY-MM-DD HH24:MI'), 5);
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES
(60, 42, 40, 'REPOSICAO', TO_DATE('2025-03-09 09:40', 'YYYY-MM-DD HH24:MI'), 8);
INSERT INTO VISITA (ID_VISITA, ID_VIAGEM, ID_MAQUINA, MOTIVO, DATA_VISITA, DISTANCIA) VALUES
(61, 42, 41, 'REPOSICAO', TO_DATE('2025-03-09 10:20', 'YYYY-MM-DD HH24:MI'), 6);


-- Para viagem 39 (4 máquinas)
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES 
(48, 38, 38, 48, 110, TO_DATE('2025-03-10', 'YYYY-MM-DD'), 'Reposição completa');
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES
(49, 39, 38, 49, 95, TO_DATE('2025-03-10', 'YYYY-MM-DD'), 'Reposição parcial');
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES
(50, 40, 38, 50, 105, TO_DATE('2025-03-10', 'YYYY-MM-DD'), 'Reposição extra');
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES
(51, 41, 38, 51, 85, TO_DATE('2025-03-10', 'YYYY-MM-DD'), 'Reposição mínima');

-- Para viagem 40 (3 máquinas)
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES 
(52, 38, 38, 52, 90, TO_DATE('2025-03-12', 'YYYY-MM-DD'), 'Reposição rápida');
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES
(53, 39, 38, 53, 115, TO_DATE('2025-03-12', 'YYYY-MM-DD'), 'Reposição prioritária');
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES
(54, 41, 38, 54, 100, TO_DATE('2025-03-12', 'YYYY-MM-DD'), 'Reposição padrão');

-- Para viagem 41 (4 máquinas)
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES 
(55, 38, 38, 55, 120, TO_DATE('2025-03-14', 'YYYY-MM-DD'), 'Reposição total');
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES
(56, 39, 38, 56, 80, TO_DATE('2025-03-14', 'YYYY-MM-DD'), 'Reposição básica');
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES
(57, 40, 38, 57, 110, TO_DATE('2025-03-14', 'YYYY-MM-DD'), 'Reposição completa');
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES
(58, 41, 38, 58, 95, TO_DATE('2025-03-14', 'YYYY-MM-DD'), 'Reposição final');

-- Para viagem 42 (3 máquinas)
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES 
(59, 38, 38, 59, 105, TO_DATE('2025-03-09', 'YYYY-MM-DD'), 'Reposição normal');
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES
(60, 40, 38, 60, 90, TO_DATE('2025-03-09', 'YYYY-MM-DD'), 'Reposição parcial');
INSERT INTO REPOSICAO (ID_REPOSICAO, ID_COMPARTIMENTO, ID_PRODUTO, ID_VISITA, QUANTIDADE_REPOSTA, DATA_REPOSICAO, DESCRICAO) VALUES
(61, 41, 38, 61, 115, TO_DATE('2025-03-09', 'YYYY-MM-DD'), 'Reposição extra');



C--CRIAR VIEW PARA IR BUSACR O ARMAZEM COM MAIS VIAGENS INICIADAS NO ANO ATUAL
CREATE OR REPLACE VIEW VIEW_ARMAZEM_MAIS_VISITAS AS
SELECT * FROM (
    SELECT R.ID_ARMAZEM,
            A.DESIGNACAO AS ARMAZEM,
            COUNT(VG.ID_VIAGEM) AS N_VIAGENS
    FROM ROTA R
    JOIN VIAGEM VG ON R.ID_ROTA = VG.ID_ROTA
    JOIN ARMAZEM A ON R.ID_ARMAZEM = A.ID_ARMAZEM
    WHERE VG.DATA_HORA_INICIO >= TRUNC(SYSDATE, 'YEAR')
    GROUP BY R.ID_ARMAZEM, A.DESIGNACAO
    ORDER BY N_VIAGENS DESC)
WHERE ROWNUM = 1;


CREATE OR REPLACE VIEW VIEW_I AS 
SELECT * FROM (
    SELECT A.DESIGNACAO AS ARMAZEM,
           M.DESIGNACAO AS MAQUINA,
           COUNT(VI.ID_VISITA) AS N_VISITAS,
           SUM(P.QUANT_EM_MAQUINAS) AS QUANT_TOTAL,
           AVG(P.QUANT_EM_MAQUINAS) AS QUANT_MEDIA_VISITA,
           (COUNT(DISTINCT P.ID_PRODUTO) / COUNT(VI.ID_VISITA)) AS N_PROD_DIF
    FROM ARMAZEM A
    JOIN ROTA R ON A.ID_ARMAZEM = R.ID_ARMAZEM
    JOIN VIAGEM VG ON R.ID_ROTA = VG.ID_ROTA 
    JOIN VISITA VI ON VG.ID_VIAGEM = VI.ID_VIAGEM 
    JOIN MAQUINA M ON VI.ID_MAQUINA = M.ID_MAQUINA
    JOIN POSSUI PO ON M.ID_MAQUINA = PO.ID_MAQUINA
    JOIN PRODUTO P ON PO.ID_PRODUTO = P.ID_PRODUTO
    JOIN VIEW_ARMAZEM_MAIS_VISITAS V ON A.ID_ARMAZEM = V.ID_ARMAZEM
    WHERE VG.DATA_HORA_INICIO >= TRUNC(SYSDATE, 'YEAR')
    GROUP BY A.DESIGNACAO, M.DESIGNACAO
    ORDER BY N_VISITAS DESC
)
WHERE ROWNUM <= 3;

INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM)
VALUES (46, 10, TO_DATE('2025-01-15 08:30:00', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2025-01-15 12:30:00', 'YYYY-MM-DD HH24:MI:SS'), 120);

INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM)
VALUES (47, 10, TO_DATE('2025-02-10 09:00:00', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2025-02-10 13:00:00', 'YYYY-MM-DD HH24:MI:SS'), 150);

INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM)
VALUES (48, 10, TO_DATE('2025-03-05 07:45:00', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2025-03-05 11:45:00', 'YYYY-MM-DD HH24:MI:SS'), 100);

INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM)
VALUES (49, 10, TO_DATE('2025-04-01 10:00:00', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2025-04-01 14:00:00', 'YYYY-MM-DD HH24:MI:SS'), 200);

INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM)
VALUES (50, 10, TO_DATE('2025-05-20 06:30:00', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2025-05-20 10:30:00', 'YYYY-MM-DD HH24:MI:SS'), 180);

INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM)
VALUES (51, 10, TO_DATE('2025-06-15 08:00:00', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2025-06-15 12:00:00', 'YYYY-MM-DD HH24:MI:SS'), 140);

INSERT INTO VIAGEM (ID_VIAGEM, ID_ROTA, DATA_HORA_INICIO, DATA_HORA_FIM, DISTANCIA_KM)
VALUES (52, 10, TO_DATE('2025-07-10 09:15:00', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2025-07-10 13:15:00', 'YYYY-MM-DD HH24:MI:SS'), 160);

--Criar uma vista que apresente o numero de produtos vendidos por mes de um tipo
CREATE OR REPLACE VIEW VIEW_J_2023139070 AS
SELECT 
    P.TIPO,
    EXTRACT(MONTH FROM DATA_HORA) AS MES,
    EXTRACT(YEAR FROM DATA_HORA) AS ANO,
    COUNT(*) AS TOTAL_VENDAS
FROM VENDA V
JOIN PRODUTO P ON V.ID_PRODUTO=P.ID_PRODUTO
GROUP BY P.TIPO, EXTRACT(MONTH FROM DATA_HORA), EXTRACT(YEAR FROM DATA_HORA);

--Criar uma view para obter as maquinas com um numero de reabastecimentos acima da media
CREATE OR REPLACE VIEW VIEW_K_2023139070 AS
    SELECT C.ID_MAQUINA, 
    M.DESIGNACAO,
    COUNT(*) AS REABASTECIMENTOS    
    FROM REPOSICAO R
    JOIN COMPARTIMENTO C ON R.ID_COMPARTIMENTO = C.ID_COMPARTIMENTO
    JOIN MAQUINA M ON C.ID_MAQUINA = M.ID_MAQUINA
    GROUP BY C.ID_MAQUINA, M.DESIGNACAO
    HAVING COUNT(*) > (SELECT AVG(REABASTECIMENTOS) 
                       FROM (SELECT COUNT(*) AS REABASTECIMENTOS 
                             FROM REPOSICAO R 
                             JOIN COMPARTIMENTO C ON R.ID_COMPARTIMENTO = C.ID_COMPARTIMENTO 
                             GROUP BY C.ID_MAQUINA));

--CRIAR UMA VISTA QUE APRESENTA O TOTAL DE VENDAS POR PRODUTO E MÁQUINA NO MÊS ANTERIOR
CREATE OR REPLACE VIEW VIEW_J_2023146252 AS 
SELECT  
    ID_MAQUINA,
    ID_PRODUTO,
    COUNT(*) AS TOTAL_VENDAS
FROM VENDA
WHERE EXTRACT(MONTH FROM DATA_HORA) = EXTRACT(MONTH FROM ADD_MONTHS(SYSDATE, -1))
  AND EXTRACT(YEAR FROM DATA_HORA) = EXTRACT(YEAR FROM ADD_MONTHS(SYSDATE, -1))
GROUP BY ID_MAQUINA, ID_PRODUTO;

--CRIAR UMA VISTA QUE APRESENTA INFORMAÇÕES SOBRE VISITAS A MÁQUINAS QUE FORAM VISITADAS APENAS UMA VEZ
CREATE OR REPLACE VIEW VIEW_K_2023146252 AS 
SELECT 
    V.ID_VISITA,
    VI.DATA_HORA_INICIO AS DATA_VIAGEM,
    M.ID_MAQUINA,
    M.DESIGNACAO,
    M.LOCALIZACAO
FROM VISITA V
JOIN VIAGEM VI ON V.ID_VIAGEM = VI.ID_VIAGEM
JOIN MAQUINA M ON V.ID_MAQUINA = M.ID_MAQUINA
WHERE V.ID_MAQUINA IN (
    SELECT ID_MAQUINA
    FROM VISITA
    GROUP BY ID_MAQUINA
    HAVING COUNT(*) = 1
);
